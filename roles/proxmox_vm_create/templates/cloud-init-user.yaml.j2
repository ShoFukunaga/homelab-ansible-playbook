#cloud-config
hostname: {{ item.name }}
timezone: {{ timezone }}
manage_etc_hosts: true
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
{% for key in fetched_ssh_keys %}
      - {{ key }}
{% endfor %}
ssh_pwauth: false
package_upgrade: true
packages:
  - qemu-guest-agent
runcmd:
  # SSH鍵認証のみを許可（パスワード認証を明示的に無効化）
  - sed -i 's/^.*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
  - systemctl restart ssh
  - systemctl enable --now qemu-guest-agent
  - 'echo "Cloud-Init完了: $(date)" >> /var/log/cloud-init-custom.log'
